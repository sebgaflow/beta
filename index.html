<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Airtable</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    button {
      background: #8e8e93;
      color: white;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
    }
    #mensaje {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Formulario de Registro</h2>
    <form id="formulario">
      <select name="dependencia" required>
        <option value="">Selecciona una dependencia</option>
        <option value="DIF Morelos">DIF Morelos</option>
        <option value="CEAGUA">CEAGUA</option>
        <option value="COEVAL">COEVAL</option>
        <option value="Consejería Jurídica">Consejería Jurídica</option>
        <option value="Consejo de Ciencia y Tecnología">Consejo de Ciencia y Tecnología</option>
        <option value="Coordinación General de Movilidad y Transporte">Coordinación General de Movilidad y Transporte</option>
        <option value="Dirección de Atención a Migrantes">Dirección de Atención a Migrantes</option>
        <option value="IMPAJOVEN">IMPAJOVEN</option>
        <option value="INEIEM">INEIEM</option>
        <option value="Instituto de Deporte y Cultura Física del Estado de Morelos">Instituto de Deporte y Cultura Física del Estado de Morelos</option>
        <option value="Instituto de Economía y Bienestar">Instituto de Economía y Bienestar</option>
        <option value="IPIAM">IPIAM</option>
        <option value="Jefatura de la Oficina de la Gubernatura">Jefatura de la Oficina de la Gubernatura</option>
        <option value="SDEyT">SDEyT</option>
        <option value="Secretaría de Administración">Secretaría de Administración</option>
        <option value="Secretaría de Bienestar">Secretaría de Bienestar</option>
        <option value="Secretaría de Contraloría">Secretaría de Contraloría</option>
        <option value="Secretaría de Cultura">Secretaría de Cultura</option>
        <option value="Secretaría de Desarrollo Agropecuario">Secretaría de Desarrollo Agropecuario</option>
        <option value="Secretaría de Desarrollo Sustentable">Secretaría de Desarrollo Sustentable</option>
        <option value="Secretaría de Educación">Secretaría de Educación</option>
        <option value="Secretaría de Gobierno">Secretaría de Gobierno</option>
        <option value="Secretaría de Hacienda">Secretaría de Hacienda</option>
        <option value="Secretaría de Infraestructura">Secretaría de Infraestructura</option>
        <option value="Secretaría de las Mujeres">Secretaría de las Mujeres</option>
        <option value="Secretaría de prueba">Secretaría de prueba</option>
        <option value="Secretaría de Salud">Secretaría de Salud</option>
        <option value="Secretaría de Seguridad y Protección Ciudadana">Secretaría de Seguridad y Protección Ciudadana</option>
        <option value="Secretaría de Turismo">Secretaría de Turismo</option>
      </select>
      <input name="promotor" placeholder="Promotor" required>
      <input name="nombres" placeholder="Nombre(s)" required>
      <input name="apellido1" placeholder="Primer Apellido" required>
      <input name="apellido2" placeholder="Segundo Apellido" required>
      <input name="calle" placeholder="Calle" required>
      <input name="numext" type="number" placeholder="Número exterior" required>
      <input name="numint" placeholder="Número interior">
      <input name="colonia" placeholder="Colonia" required>
      <input name="cp" type="number" placeholder="Código postal" required>
      <input name="seccion" type="number" placeholder="Clave de sección" required>
      <input name="telefono" placeholder="Teléfono a 10 dígitos" required>
      <button type="submit">Enviar</button>
    </form>
    <div id="mensaje"></div>
  </div>

  <script>
    const token = "patpwEeJi6lj1kVSA.96038881b98860c419b2dd70e45e3e70d5e7336b9124a86b7d0caf5a270173fc";
    const baseId = "appi5iq2xznnBxNvJ";
    const tableId = "tblefXMYV3zUmEwXk";
    const fields = {{
      dependencia: "fldUxubMvcv8fTvUl",
      promotor: "fldBYSsQW7AuCZIxw",
      nombres: "fldZD3e40hfZWkBrC",
      apellido1: "fldvTQJ9AJXZAq6Go",
      apellido2: "fldmZn2MhygKGbp5E",
      calle: "fldTXQpUayq03SqGP",
      numext: "fldzcyV7OD3UHbdyx",
      numint: "fldllGor8QzaTactq",
      colonia: "fldnVmj53rvm5RsdQ",
      cp: "fldU13HKpwypVx3qt",
      seccion: "fldhRiT7s8cnZJKhN",
      telefono: "fldPByjAjeIbIQB0t"
    }};

    document.getElementById("formulario").addEventListener("submit", async function(e) {{
      e.preventDefault();
      const f = new FormData(this);

      const filter = encodeURIComponent(`OR({${{fields.telefono}}} = '${{f.get("telefono")}}', AND({${{fields.nombres}}} = '${{f.get("nombres")}}', {${{fields.apellido1}}} = '${{f.get("apellido1")}}', {${{fields.apellido2}}} = '${{f.get("apellido2")}}'))`);

      const res = await fetch(`https://api.airtable.com/v0/${{baseId}}/${{tableId}}?filterByFormula=${{filter}}`, {{
        headers: {{ Authorization: `Bearer ${{token}}` }}
      }});
      const json = await res.json();

      if (json.records && json.records.length > 0) {{
        document.getElementById("mensaje").innerText = "❌ Ya existe un registro duplicado.";
        document.getElementById("mensaje").style.color = "red";
        return;
      }}

      const record = {{
        fields: {{
          [fields.dependencia]: f.get("dependencia"),
          [fields.promotor]: f.get("promotor"),
          [fields.nombres]: f.get("nombres"),
          [fields.apellido1]: f.get("apellido1"),
          [fields.apellido2]: f.get("apellido2"),
          [fields.calle]: f.get("calle"),
          [fields.numext]: parseInt(f.get("numext")),
          [fields.numint]: f.get("numint"),
          [fields.colonia]: f.get("colonia"),
          [fields.cp]: parseInt(f.get("cp")),
          [fields.seccion]: parseInt(f.get("seccion")),
          [fields.telefono]: f.get("telefono")
        }}
      }};

      const save = await fetch(`https://api.airtable.com/v0/${{baseId}}/${{tableId}}`, {{
        method: "POST",
        headers: {{
          Authorization: `Bearer ${{token}}`,
          "Content-Type": "application/json"
        }},
        body: JSON.stringify(record)
      }});

      if (save.ok) {{
        document.getElementById("mensaje").innerText = "✅ Registro exitoso.";
        document.getElementById("mensaje").style.color = "green";
        this.reset();
      }} else {{
        document.getElementById("mensaje").innerText = "❌ Error al enviar el formulario.";
        document.getElementById("mensaje").style.color = "red";
      }}
    }});
  </script>
</body>
</html>
